<!DOCTYPE HTML>
<!--
	forked from:
	Dopetrope by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Enemy Detection and Firing</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="/theme/css/ie/html5shiv.js"></script><![endif]-->
        <script type="application/javascript">
            var FINAL_PARSEC_THEME_STATIC_DIR = '/theme' + '/';
        </script>
		<script src="/theme/js/jquery.min.js"></script>
		<script src="/theme/js/jquery.dropotron.min.js"></script>
		<script src="/theme/js/skel.min.js"></script>
		<script src="/theme/js/skel-layers.min.js"></script>
		<script src="/theme/js/init.js"></script>
		<noscript>
			<link rel="stylesheet" href="/theme/css/skel.css" />
			<link rel="stylesheet" href="/theme/css/style.css" />
			<link rel="stylesheet" href="/theme/css/style-desktop.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="/theme/css/ie/v8.css" /><![endif]-->

        <!-- For Unity Web Player -->
        <script type="text/javascript" src="//webplayer.unity3d.com/download_webplayer-3.x/3.0/uo/UnityObject2.js"></script>
        <![if IE]>
        <script type='text/javascript'>
        if(/*@cc_on!@*/false)
        var bIsIE = 1;
        </script>
        <![endif]>
        <script language="javascript1.1" type="text/javascript">
            function detectUnityWebPlayer () {
                var tInstalled = false;
                if (typeof (bIsIE) != 'undefined') {
                    tInstalled = true;
                }
                if (navigator.userAgent.indexOf('MSIE') !== -1 || navigator.appVersion.indexOf('Trident/') > 0) {
                   // MSIE
                    tInstalled = true;
                }

                if (navigator.appVersion.indexOf("MSIE") != -1 &&
                    navigator.appVersion.toLowerCase().indexOf("win") != -1)
                {
                    tInstalled = detectUnityWebPlayerActiveX();
                }
                else if (navigator.mimeTypes && navigator.mimeTypes["application/vnd.unity"])
                {
                    if (navigator.mimeTypes["application/vnd.unity"].enabledPlugin &&
                        navigator.plugins && navigator.plugins["Unity Player"])
                    {
                        tInstalled = true;
                    }
                }
                return tInstalled;
            }
        </script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-37270839-4', 'auto');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
	</head>
<body class="right-sidebar">
<!-- Header -->
<div id="header-wrapper">
    <div id="header">

        <!-- Logo -->
        <h1><a href="/index.html">FINAL PARSEC</a></h1>

<!-- Nav -->
<nav id="nav">
    <ul>
        <li><a href="/index.html">Home</a></li>
        <li>
            <a href="#" onclick="return false;">Games</a>
            <ul>
                    <li><a href="/category/nauticus.html">Nauticus</a></li>
                    <li><a href="/category/space-snakes-legacy-earth.html">Space Snakes: Legacy Earth</a></li>
                    <li><a href="/category/space-snakes-prototype.html">Space Snakes : Prototype</a></li>
                    <li><a href="/category/tower-defense.html">Tower Defense</a></li>
                    <li><a href="/category/unity-masters.html">Unity Masters</a></li>
            </ul>
        </li>
        <li><a href="/tag/tutorial.html">Tutorials</a></li>
        <li><a href="/archives.html">Blog</a></li>
        <li><a href="/final_parsec_the_reckoning/static_pages/about.html">About</a></li>
    </ul>
</nav>
    </div>
</div>
    <!-- Main -->
        <div id="main-wrapper">
            <div class="container">
                <div class="row">
                    <div class="8u">

                        <!-- Content -->
                            <article class="box post">
                                <a href="#" class="image featured">
                                    <img onerror="this.parentNode.parentNode.removeChild(this.parentNode);"
                                         src="/theme/images/post-header/tower-defense-enemy-detection-and-firing.jpg" alt="" />
                                </a>
                                <header>
                                    <h2>Enemy Detection and Firing</h2>
                                    <p>Sun 23 November 2014</p>
                                </header>
                                <p>
    Learn how to make turrets detect enemies and shoot projectiles at them.
    A continuation of the tower defense tutorial series.
</p>

<h3>Setting Up Your Turret GameObject</h3>

<p>
    Go ahead and get started by creating a Sprite in your hierarchy.
</p>

<p>
    This should create a new <a href="http://docs.unity3d.com/Manual/class-GameObject.html" target="_blank">GameObject</a> 
    with the <a href="http://docs.unity3d.com/Manual/class-Transform.html" target="_blank">Transform</a> and 
    <a href="http://docs.unity3d.com/Manual/class-SpriteRenderer.html" target="_blank">Sprite Renderer</a> components        
</p>

<p>  
    Don't worry too much about changing the position; we're going to be setting that programmatically when the player tries to place a turret on the map.
    Do, however, add some cool art to the Sprite property of your renderer.
</p>

<p>
    <span class="caption">This is what we're using for our Earth Type Turrets. Maybe one day we'll hire an artist...</span>
    <img src="/theme/images/tower_defense_enemy_detection_and_firing_earth_turret_art.png">
</p>

<p>
    Attach a MonoBehavior script and call it <span style='font-weight: bold;'>Turret.cs</span>.
</p>

<p>
    Attach a <a href="http://docs.unity3d.com/Manual/class-SphereCollider.html" target="_blank">Sphere Collider</a> too.
    Make sure the <span style='font-weight: bold;'>Is Trigger</span> property is checked.
    Don't worry about changing values for <span style='font-weight: bold;'>Center</span> and <span style='font-weight: bold;'>Radius</span>
    as we'll be changing these programmatically.
</p>

<p>

    <img src="/theme/images/tower_defense_enemy_detection_and_firing_earth_turret_components.png">
    <span class="caption">Your GameObject's components should look something like this.</span>
</p>

<p>
    Go ahead and create a prefab by dragging the turret from your scene to a directory in the project tab.
    Having our turrets as prefabs will give the benefit of being able to instantiate them from code.
    We can even create multiple prefabs which will allow for different turret types, each with their own stats, special abilities, and artwork.
</p>

<h3>Writing the Scripts</h3>

<p>
    Open up the <span style='font-weight: bold;'>Turret.cs</span> attached to your prefab. It should look something like this:
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using System.Linq;

public class Turret : MonoBehaviour
{

    // Use this for initialization
    void Start () {

    }

    // Update is called once per frame
    void Update () {

    }
}</code></pre>

<p><span class="caption">Take note I've added a couple <span class='hljs-keyword'>using</span> statements.</span></p>
<p>
    Let's add some fields and properties. Keep in mind the public fields will be accessible in Unity's inspector panel. 
    <span style='font-weight: bold;'>damage</span>, <span style='font-weight: bold;'>range</span>, and <span style='font-weight: bold;'>rateOfFire</span> are all meant to adjusted there on a 0-10 scale.
    The associated properties <span style='font-weight: bold;'>AttackDelay</span> and <span style='font-weight: bold;'>DetectionRadius</span> scale those values to based on the size of the map.
    <span style='font-weight: bold;'>DetectionRadius</span> also takes responsibility for changing the size of the attached sphere collider. 
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>// Configurable
public float accuracyError = 2.0f;
public int damage = 10;
public GameObject projectileType;
public int range = 5;
public int rateOfFire = 5;

// Constants
private const float MinAttackDelay = 0.1f;
private const float MaxAttackDelay = 2f;

// Internal
private List<EnemyBase> myTargets;
private float nextDamageEvent;
private ObjectManager objectManager;    
private static readonly object syncRoot = new object ();

// Properties
private float AttackDelay
{
    get 
    {
        int inverted = rateOfFire;
        if (rateOfFire == 0) 
        { 
            return float.MaxValue;
        }
        else if (rateOfFire < 5)
        {
            inverted = rateOfFire + 2 * (5 - rateOfFire);
        }
        else if (rateOfFire > 5) 
        {
            inverted = rateOfFire - 2 * (rateOfFire - 5);
        }

        return (((float)inverted - 1f) / (10f - 1f)) * (MaxAttackDelay - MinAttackDelay) + .1f;
    }
}

public float DetectionRadius
{ 
    get 
    {   
        float minRange = Mathf.Min(objectManager.Map.nodeSize.x, objectManager.Map.nodeSize.y) * 1.5f;
        float maxRange = minRange * 4f;

        float detectionRadius = (((float)range - 1f) / (10f - 1f)) * (maxRange - minRange) + minRange;
        detectionRadius = detectionRadius / transform.localScale.x;

        return detectionRadius;
    }
    set 
    {
        float minRange = Mathf.Min(objectManager.Map.nodeSize.x, objectManager.Map.nodeSize.y) * 1.5f;
        float maxRange = minRange * 4f;

        float detectionRadius = (((float)value - 1f) / (10f - 1f)) * (maxRange - minRange) + minRange;
        detectionRadius = detectionRadius / transform.localScale.x;

        SphereCollider collider = transform.GetComponent<SphereCollider> ();
        collider.radius = detectionRadius;
    }
}</code></pre>

<p>
    Here we initialize some of those private fields.
    <span style='font-weight: bold;'>objectManager</span> is just a singleton we are using to help maintain game state.
    Matt talks more in-depth about it in some of the earlier videos from the <a href="/tag/td-video-series.html">Tower Defense Tutorial Video Series</a>.
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>// Runs when entity is Instantiated
void Awake()
{
    objectManager = ObjectManager.GetInstance();
    objectManager.AddEntity(this);
}

// Use this for initialization
void Start ()
{
    DetectionRadius = range;
    myTargets = new List<EnemyBase>();
}</code></pre>

<p>
    These two methods track when enemies enter and exit the attached sphere collider.
    At any given time, <span style='font-weight: bold;'>myTargets</span> should now reflect all enemies inside the sphere, the turret's detectable area.
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>void OnTriggerEnter (Collider other)
{
    if (other.gameObject.tag == "enemy") {  
        myTargets.Add (other.GetComponent<EnemyBase>());
    }
}

void OnTriggerExit (Collider other)
{
    lock (syncRoot) {
        if (other != null &&
            myTargets.Select (t => t!= null && t.gameObject).Contains(other.gameObject)) {
            myTargets.Remove (other.GetComponent<EnemyBase>());
        }
    }

}</code></pre>

<h3>Killing Dudes with Projectiles</h3>

<p>
    In order to create a projectile, create a new <a href="http://docs.unity3d.com/Manual/class-GameObject.html" target="_blank">GameObject</a> starting with as a sphere. 
    I ended up adding a <a href="http://docs.unity3d.com/Manual/class-MeshRenderer.html" target="_blank">Mesh Renderer</a> and a <a href="http://docs.unity3d.com/Manual/class-LineRenderer.html" target="_blank">Line Renderer</a> to get it to look like a bullet.
    Attach a MonoBehavior script called <span style='font-weight: bold;'>Projectile.cs</span>.
    Go ahead and make a prefab from this object the same way you did for turrets.
</p>

<p>
     Nothing too crazy going on in this script.
     It requires a target enemy (and associated location) and just homes in on it until it "hits".
     We're not doing any collision detection here, but rather checking distance between the projectile and its target.
     Once the projectile reaches the target, it destroys itself and damages the enemy by subtracting from its health. 
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>using UnityEngine;
using System.Collections;

public class Projectile : MonoBehaviour
{
    // Configurable
    public float range;
    public float speed;
    public EnemyBase target;
    public Vector3 targetPosition;

    public int Damage { get; set; }

    // Internal
    private float distance;

    // Runs when entity is Instantiated
    void Awake ()
    {
        distance = 0;
    }

    // Update is called once per frame
    void Update ()
    {
        Vector3 moveVector = new Vector3 (transform.position.x - targetPosition.x,
                                         transform.position.y - targetPosition.y,
                                         transform.position.z - targetPosition.z).normalized;

        // update the position
        transform.position = new Vector3 (transform.position.x - moveVector.x * speed * Time.deltaTime,
                                         transform.position.y - moveVector.y * speed * Time.deltaTime,
                                         transform.position.z - moveVector.z * speed * Time.deltaTime);

        distance += Time.deltaTime * speed;

        if (distance > range ||
            Vector3.Distance (transform.position, new Vector3 (targetPosition.x, targetPosition.y, targetPosition.z)) < 1) 
        {
            Destroy (gameObject);
            if (target != null) 
            {
                target.Damage (Damage);
            }
        }
    }
}</code></pre>

<p>
    Now that projectiles are good to go, drag that new projectile prefab onto the <span style='font-weight: bold;'>projectileType</span> field (in the inspector when you've got a turret selected).
    Next, you'll need the following two methods to make the turret "fire" projectiles.
    All we're doing is setting up a loop where the turret instantiates new projectiles targeted at a random enemy within range.
</p>

<pre class='apply-line-numbers'><code class='hljs cs'>void Fire (EnemyBase myTarget)
{
    var targetPosition = myTarget.transform.position;
    var aimError = Random.Range (-accuracyError, accuracyError);
    var aimPoint = new Vector3 (targetPosition.x + aimError, targetPosition.y + aimError, targetPosition.z + aimError);
    nextDamageEvent = Time.time + AttackDelay;
    GameObject projectileObject = Instantiate (projectileType, transform.position, Quaternion.LookRotation (targetPosition)) as GameObject;
    Projectile projectile = projectileObject.GetComponent<Projectile> ();
    projectile.Damage = damage;
    projectile.target = myTarget;
    projectile.targetPosition = aimPoint;
}

// Update is called once per frame
void Update ()
{
    lock(syncRoot)
    {
        if (myTargets.Any())
        {
            EnemyBase myTarget = myTargets.ElementAt(Random.Range(0, myTargets.Count));


            if (myTarget != null) {
                if (Time.time >= nextDamageEvent)
                {
                    Fire(myTarget);
                }
            }
            else
            {
                nextDamageEvent = Time.time + AttackDelay;
                myTargets.Remove(myTarget);
            }              
        }
    }       
}</code></pre>

<p>
    To fill in some of the gaps like placing turrets on the map and spawning enemies, I encourage you to go take a look at some of the earlier videos from the <a href="/tag/td-video-series.html">Tower Defense Tutorial Video Series</a>. 
</p>
                                <hr>
                                <p>Posted to: <a href="/category/tower-defense.html">Tower Defense</a></p>
    <p>
            <a href="/tag/tower-defense.html" class="tag" style="color:black; text-decoration: none;"><i class="fa fa-tag"></i> tower-defense</a><br>
            <a href="/tag/unity.html" class="tag" style="color:black; text-decoration: none;"><i class="fa fa-tag"></i> unity</a><br>
            <a href="/tag/tutorial.html" class="tag" style="color:black; text-decoration: none;"><i class="fa fa-tag"></i> tutorial</a><br>
            <a href="/tag/turret.html" class="tag" style="color:black; text-decoration: none;"><i class="fa fa-tag"></i> turret</a><br>
    </p>
                            </article>

                    </div>
                    <div class="4u">

                        <!-- Sidebar -->
                            <section class="box">
                                <a href="/author/baer.html" class="image featured"><img src="/theme/images/author-portrait/Baer.jpg" alt="" /></a>
                                <header>
                                    <h3>Baer</h3>
                                </header>
                                <p>
                                        Director of Snacks
                                </p>
                                <footer>
                                    <a href="/author/baer.html" class="button alt">My Articles</a>
                                </footer>
                            </section>
                            <section class="box">
                                <header>
                                    <h3>Latest Tweets</h3>
                                </header>

                                <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/Final_Parsec" data-widget-id="564606085340729344">Tweets by @Final_Parsec</a>
                                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                            </section>
                    </div>
                </div>
            </div>
        </div>

    <!-- Footer -->
        <div id="footer-wrapper">
            <section id="footer" class="container">
                <div class="row">
                    <div class="8u">
                            <section id="content" class="body">
                                <header><h2>Related articles</h2></header>
                                <ul class="dates">
                                        <li>
                                            <span class="date">Oct <strong>02</strong></span>
                                            <h3><a href="/tower-defense-interfacing-with-the-map.html">Tower Defense Tutorials Part 2: Interfacing with the Map</a></h3>
                                            <p><p>The second video tutorial of a series which takes you through the process of building a tower defense game.</p></p>
                                        </li>
                                        <li>
                                            <span class="date">Sep <strong>28</strong></span>
                                            <h3><a href="/tower-defense-no-gameobject-grid.html">Announcing the Tower Defense Tutorial Video Series!</a></h3>
                                            <p><p>The first video tutorial of a series which takes you through the process of building a tower defense game.</p></p>
                                        </li>
                                        <li>
                                            <span class="date">Oct <strong>12</strong></span>
                                            <h3><a href="/tower-defense-moving-enemies-and-pathfinding.html">Tower Defense Tutorials Part 3: Enemies and Pathfinding</a></h3>
                                            <p><p>The third video tutorial of a series which takes you through the process of building a tower defense game.</p></p>
                                        </li>
                                        <li>
                                            <span class="date">Feb <strong>28</strong></span>
                                            <h3><a href="/legacy-earth-turrets-and-missiles.html">Turrets and Missiles Tutorial</a></h3>
                                            <p><p>Video tutorial about turrets and missiles in a rail shooter built with Unity3d.</p></p>
                                        </li>
                                        <li>
                                            <span class="date">Mar <strong>15</strong></span>
                                            <h3><a href="/parallax-for-dummies.html">Parallax for Dummies</a></h3>
                                            <p><p>An enlightening guide on how to create a simple parallax effect in Unity. Using parallax is a really cool way to breathe life into your games.</p></p>
                                        </li>
                                </ul>
                            </section>
                    </div>

<div class="4u">
    <section>
        <header>
            <h2>What's a Final Parsec?</h2>
        </header>
        <a href="#" class="image featured"><img src="/theme/images/final_parsec.jpg" alt="" /></a>
        <p>
            <strong>Final Parsec</strong> is an up and coming indie game development studio in North Texas.
        </p>
        <p>
            Our game development team consists of<br>
            <a href="/author/matt.html">Matt Bauer</a>, <a href="/author/baer.html">Baer Bradford</a>, and <a href="/author/tj.html">TJ Brosnan</a>.
        </p>
        <footer>
            <a href="/final_parsec_the_reckoning/static_pages/about.html" class="button">Find out more</a>
        </footer>
    </section>

    <section>
        <header>
            <h2>Social</h2>
        </header>
        <ul class="social">
            <li><a class="icon fa-twitter" href="https://twitter.com/Final_Parsec"><span class="label">@FinalParsec</span></a></li>
            <li><a class="icon fa-youtube" href="https://www.youtube.com/channel/UCHcxGunEdEPlgq5JulJ2fYQ"><span class="label">Tutorials & Streams</span></a></li>
        </ul>
    </section>
</div>                </div>

<div class="row">
    <div class="12u">

        <!-- Copyright -->
            <div id="copyright">
                <ul class="links">
                    <li>&copy; 2015 Final Parsec - All Rights Reserved</li>
                </ul>
            </div>
    </div>
</div>            </section>
        </div>
</body>
</html>